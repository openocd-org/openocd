# SPDX-License-Identifier: GPL-2.0-or-later
# OpenOCD Target Config for Microchip WBZ451
# Author: Dinesh Arasu (dinesh.arasu@microchip.com)

# --- Setup DAP and CPU ---
source [find target/swj-dp.tcl]

if { [info exists CHIPNAME] } {
   set _CHIPNAME $CHIPNAME
} else {
   set _CHIPNAME wbz451
}

if { [info exists ENDIAN] } {
   set _ENDIAN $ENDIAN
} else {
   set _ENDIAN little
}

if { [info exists DAP_TAPID] } {
   set _DAP_TAPID $DAP_TAPID
} else {
   set _DAP_TAPID 0x04D8810B
}

transport select swd

swj_newdap $_CHIPNAME cpu -irlen 4 -expected-id $_DAP_TAPID
dap create $_CHIPNAME.dap -chain-position $_CHIPNAME.cpu

set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME cortex_m -endian $_ENDIAN -dap $_CHIPNAME.dap

# --- Work Area in RAM ---
$_TARGETNAME configure -work-area-phys 0x20000000 \
                       -work-area-size 0x20000 \
                       -work-area-backup 0

# --- Reset Behavior ---
$_TARGETNAME configure -event reset-deassert-post {
        wbz451 dsu_reset_deassert
}

reset_config srst_only srst_nogate

adapter speed 2000

if {![using_hla]} {
   cortex_m reset_config sysresetreq
}

# --- Flash Banks ---
flash bank wbz451_flash wbz451 0x01000000 0x00100000 0 0 $_TARGETNAME

flash bank wbz451_boot wbz451 0x00000000 0x5000 0 0 $_TARGETNAME

flash bank wbz451_device_config wbz451 0x00005000 0x1000 0 0 $_TARGETNAME

flash bank wbz451_otp wbz451 0x00006000 0x1000 0 0 $_TARGETNAME

flash bank wbz451_configbits wbz451 0x00045000 0x2000 0 0 $_TARGETNAME

flash bank wbz451_config_CM4F wbz451 0xE000ed10 0x100 0 0 $_TARGETNAME